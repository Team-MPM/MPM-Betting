@page "/league/{Id:int?}"
@using LanguageExt
@inject FootballApi Api
@using MPM_Betting.Services
@using MPM_Betting.Services.Data
@using Blazor.ComponentLibrary.DesktopView
@using Blazorise.Extensions
@using MPM_Betting.Blazor.ComponentLibrary.DesktopView
@using MudBlazor

@rendermode InteractiveServer
@attribute [StreamRendering]

<div class="row">
    <NavBar/>
</div>

@if (LeagueEntry is null || LeagueTable.Table.IsNullOrEmpty())
{
    <div class="">League not found!</div>
}
else
{
    <div class="container">
        <div class="row LeagueInfoBox">
            <div class="col-1"></div>
            <div class="col-2">
                <img class="LeagueBoxIcon" src="https://images.fotmob.com/image_resources/logo/leaguelogo/dark/@(Id).png" height="100px"/>
            </div>
            <div class="col-9">
                <h1>@LeagueEntry?.Name</h1>
            </div>
        </div>
        <div class="row LeagueTable">
            <MudSimpleTable Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" Style="overflow-x: auto;">
                <thead>
                <tr>
                    @foreach (var h in headings)
                    {
                        <th>@h</th>
                    }
                </tr>
                </thead>
                <tbody>
                    @foreach (var team in LeagueTable.Table)
                    {
                        <tr>
                            <td>@team.Rank</td>
                            <td><img class="TeamImage" src="https://images.fotmob.com/image_resources/logo/teamlogo/@(team.Team.Id).png"/> @team.Team.Name</td>
                            <td>@team.Won</td>
                            <td>@team.Drawn</td>
                            <td>@team.Lost</td>
                            <td>@(team.GoalsFor - team.GoalsAgainst)</td>
                            <td>@team.Points</td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        </div>
    </div>
}

@code {
    //table 
    private bool dense = false;
    private bool hover = true;
    private bool striped = false;
    private bool bordered = false;
    
    string[] headings = { "#", "Team", "W", "D", "L", "+/-" ,"Points" };
    
    [Parameter] public int Id { get; set; } = default!;
    
    private FootballApi.League? LeagueEntry { get; set; }
    private FootballApi.LeagueTable LeagueTable { get; set; }

    protected async override Task OnInitializedAsync()
    {
        var response = await Api.GetAllFootballLeagues();
        if(response.IsSuccess)
        {
            LeagueEntry = response.Value.First(l => l.Id == Id);
        }

        if (LeagueEntry is not null)
        {
            var result = await Api.GetLeagueTable(LeagueEntry.Value.Id,null );
            if (result.IsSuccess)
            {
                LeagueTable = result.Value!;
            }
        }
    }
    
    protected async override Task OnParametersSetAsync()
    {
        var response = Api.GetAllFootballLeagues();
        if(response.Result.IsSuccess)
        {
            LeagueEntry = response.Result.Value.First(l => l.Id == Id);
        }
    }

}